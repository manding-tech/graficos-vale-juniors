<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8">
<title>Exploration Target</title>

<script src="https://www.gstatic.com/charts/loader.js"></script>

<style>
body{
  font-family:Arial,sans-serif;
  background:#f5f5f5;
  margin:0;
  padding:20px
}
.dashboard-bg{
  position:relative;
  padding:20px
}
.dashboard-bg::before{
  content:"";
  position:absolute;
  inset:0;
  background-image:url('fundo.jpg');
  background-size:cover;
  background-position:center;
  opacity:.25;
  z-index:0
}
.dashboard-bg>*{
  position:relative;
  z-index:1
}
.page-title{
  text-align:center;
  font-size:28px;
  font-weight:bold;
  margin-bottom:20px
}
.chart-menu{
  text-align:center;
  margin-bottom:15px
}
.chart-menu button{
  padding:8px 16px;
  margin:0 6px;
  border:none;
  border-radius:4px;
  background:#e0e0e0;
  cursor:pointer;
  font-weight:bold
}
.chart-menu button.active{
  background:#9e9e9e;
  color:#fff
}
.chart-box{
  display:none;
  width:100%;
  height:520px
}
.chart-box.active{
  display:block
}
#customTooltip{
  position:absolute;
  background:#fff;
  border:1px solid #bbb;
  padding:10px 12px;
  font-size:13px;
  line-height:1.5;
  box-shadow:0 2px 6px rgba(0,0,0,.25);
  border-radius:4px;
  display:none;
  pointer-events:none;
  z-index:9999;
  white-space:nowrap
}
.size-legend{
  margin-top:6px;
  margin-left:80px;
  font-size:15px
}
</style>

<script>
google.charts.load('current',{packages:['corechart']});
google.charts.setOnLoadCallback(init);

const CSV_JUNIORS =
'https://docs.google.com/spreadsheets/d/e/2PACX-1vSHkysTN6roFag5cFJv97rmXIsO9vKLKaAXmJxbeAD0v4klws329T8nwBI1ftUFKvrukkvLYM9vPysK/pub?gid=1447223465&single=true&output=csv';

const CSV_MAJORS = 
'https://docs.google.com/spreadsheets/d/e/2PACX-1vSld_qDJOwo6IuHoTPH4P2jf28opor0WkbCue_em-EDMlGjV5ZbN0kNHZMGxcdUsKCgkzVVys9kfu7D/pub?gid=1447223465&single=true&output=csv';

let analysisMode="MI";

function init(){ showScatter(); }

/* -------- BOTÃ•ES -------- */
function showScatter(){
  scatterBox.classList.add('active');
  bubbleBox.classList.remove('active');
  btnScatter.classList.add('active');
  btnBubble.classList.remove('active');
  drawScatter();
}
function showBubble(){
  bubbleBox.classList.add('active');
  scatterBox.classList.remove('active');
  btnBubble.classList.add('active');
  btnScatter.classList.remove('active');
  drawBubble();
}
function setAnalysisMode(m){
  analysisMode=m;
  btnMI.classList.toggle('active',m==='MI');
  btnPP.classList.toggle('active',m==='PP');
  redraw();
}
function redraw(){
  scatterBox.classList.contains('active') ? drawScatter() : drawBubble();
}

/* -------- CSV -------- */
async function loadCSV(url){
  const csv=await(await fetch(url)).text();
  return csv.trim().split('\n').slice(1);
}

/* ================= SCATTER ================= */
async function drawScatter(){

  let rows=[], links=[];
  if(chkJ.checked) rows.push(...await loadCSV(CSV_JUNIORS));
  if(chkM.checked) rows.push(...await loadCSV(CSV_MAJORS));
  if(!rows.length) return;

  rows.sort((a,b)=>parseFloat(a.split(',')[1])-parseFloat(b.split(',')[1]));

  const data=new google.visualization.DataTable();
  data.addColumn('number','Index');
  data.addColumn('number','M+I');
  data.addColumn('number',analysisMode==='MI'?'M+I':'P+P / M+I');
  data.addColumn({type:'string',role:'tooltip',p:{html:true}});

  const ticks=[];
  rows.forEach((r,i)=>{
    const c=r.split(',').map(x=>x.replace(/"/g,'').trim());
    const mi=parseFloat(c[1]);
    const val=analysisMode==='MI'?mi:parseFloat(c[2]);
    if(isNaN(mi)||isNaN(val)) return;
    data.addRow([i,mi,val,'']);
    ticks.push({v:i,f:c[0]});
    links.push(c[5]);
  });

  const chart=new google.visualization.ScatterChart(scatter);
  google.visualization.events.removeAllListeners(chart);

  google.visualization.events.addListener(chart,'onmouseover',e=>{
    if(e.row==null) return;
    const c=rows[e.row].split(',').map(x=>x.replace(/"/g,'').trim());
    const cli=chart.getChartLayoutInterface();

    customTooltip.innerHTML=`
      <strong>${c[0]}</strong><br><br>
      <b>M+I:</b> ${c[1]}<br>
      <b>P+P / M+I:</b> ${c[2]}<br>
      <b>Ore Type:</b> ${c[4]}<br>
      <b>Resources (Mt):</b> ${c[3]}
    `;
    customTooltip.style.left=scatter.offsetLeft+cli.getXLocation(data.getValue(e.row,1))+15+'px';
    customTooltip.style.top=scatter.offsetTop+cli.getYLocation(data.getValue(e.row,2))-10+'px';
    customTooltip.style.display='block';
  });

  google.visualization.events.addListener(chart,'onmouseout',()=>customTooltip.style.display='none');
  google.visualization.events.addListener(chart,'select',()=>{
    const s=chart.getSelection();
    if(s.length) window.open(links[s[0].row],'_blank');
  });

  chart.draw(data,{
    hAxis:{title:'Companies',ticks,slantedText:true,slantedTextAngle:45},
    vAxis:{title:analysisMode==='MI'?'Measured + Indicated (%)':'P+P / M+I (%)'},
    tooltip:{isHtml:true,trigger:'none'},
    pointSize:8,
    height:480,
    backgroundColor:'transparent',
    chartArea:{top:30,left:95,right:230,bottom:120}
  });
}

/* ================= BUBBLE ================= */
async function drawBubble(){

  let rows=[];
  if(chkJ.checked) rows.push(...await loadCSV(CSV_JUNIORS));
  if(chkM.checked) rows.push(...await loadCSV(CSV_MAJORS));
  if(!rows.length) return;

  rows.sort((a,b)=>parseFloat(a.split(',')[1])-parseFloat(b.split(',')[1]));

  const data=new google.visualization.DataTable();
  data.addColumn('string','id');   // STRING VAZIA = SEM TEXTO VISUAL
  data.addColumn('number','M+I');
  data.addColumn('number',analysisMode==='MI'?'M+I':'P+P / M+I');
  data.addColumn('string','Ore');
  data.addColumn('number','Resources');

  const meta=[];
  rows.forEach(r=>{
    const c=r.split(',').map(x=>x.replace(/"/g,'').trim());
    const mi=parseFloat(c[1]);
    const val=analysisMode==='MI'?mi:parseFloat(c[2]);
    const res=parseFloat(c[3]);
    if(isNaN(mi)||isNaN(val)||isNaN(res)) return;
    data.addRow(['',mi,val,c[4],res]);
    meta.push(c);
  });

  const chart=new google.visualization.BubbleChart(bubble);
  google.visualization.events.removeAllListeners(chart);

  google.visualization.events.addListener(chart,'onmouseover',e=>{
    if(e.row==null) return;
    const c=meta[e.row];
    const cli=chart.getChartLayoutInterface();

    customTooltip.innerHTML=`
      <strong>${c[0]}</strong><br><br>
      <b>M+I:</b> ${c[1]}<br>
      <b>P+P / M+I:</b> ${c[2]}<br>
      <b>Ore Type:</b> ${c[4]}<br>
      <b>Resources (Mt):</b> ${c[3]}
    `;
    customTooltip.style.left=bubble.offsetLeft+cli.getXLocation(data.getValue(e.row,1))+15+'px';
    customTooltip.style.top=bubble.offsetTop+cli.getYLocation(data.getValue(e.row,2))-10+'px';
    customTooltip.style.display='block';
  });

  google.visualization.events.addListener(chart,'onmouseout',()=>customTooltip.style.display='none');
  google.visualization.events.addListener(chart,'select',e=>{
    if(e.row!=null) window.open(meta[e.row][5],'_blank');
  });

  chart.draw(data,{
     hAxis:{ title:'Measured + Indicated (%)', minValue:-0.1, maxValue:1.0, baselineColor:'transparent' },
    vAxis:{ title:'P+P / M+I (%)', minValue:-0.1, maxValue:1.0, baselineColor:'transparent' },
    bubble:{textStyle:{fontSize:0}},
    legend:{position:'right'},
    tooltip:{trigger:'none'},
    height:420,
    backgroundColor:'transparent',
    chartArea:{top:30,left:95,right:230,bottom:60}
  });
}
</script>
</head>

<body>
<div class="dashboard-bg">

<h1 class="page-title">Pre-Feasibility Study</h1>

<div class="chart-menu">
  <button id="btnScatter" class="active" onclick="showScatter()">Scatter Chart</button>
  <button id="btnBubble" onclick="showBubble()">Bubble Chart</button>
</div>

<div class="chart-menu">
  <button id="btnMI" class="active" onclick="setAnalysisMode('MI')">M+I</button>
  <button id="btnPP" onclick="setAnalysisMode('PP')">P+P</button>
</div>

<div class="chart-menu">
  <label><input type="checkbox" id="chkJ" checked onchange="redraw()"> Juniors</label>
  <label style="margin-left:15px"><input type="checkbox" id="chkM" onchange="redraw()"> Majors</label>
</div>

<div id="scatterBox" class="chart-box active"><div id="scatter"></div></div>
<div id="bubbleBox" class="chart-box"><div id="bubble"></div><div class="size-legend">Bubble size = Resources (Mt)</div></div>

</div>
<div id="customTooltip"></div>
</body>
</html>
