<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8">
<title>Feasibility Study</title>

<script src="https://www.gstatic.com/charts/loader.js"></script>

<style>
body {
  font-family: Arial, sans-serif;
  background: #f5f5f5;
  margin: 0;
  padding: 20px;
}

.page-title {
  text-align: center;
  font-size: 28px;
  font-weight: bold;
  color: #333;
  margin-bottom: 20px;
}

.chart-menu {
  text-align: center;
  margin-bottom: 15px;
  position: relative;
  z-index: 1000;
}

.chart-menu button {
  padding: 8px 16px;
  margin: 0 6px;
  border: none;
  border-radius: 4px;
  background: #e0e0e0;
  cursor: pointer;
  font-weight: bold;
}

.chart-menu button.active {
  background: #9e9e9e;
  color: #fff;
}

.chart-box {
  display: none;
  position: relative;
  width: 100%;
  height: 520px;
}

.chart-box.active {
  display: block;
}

.chart-bg::before {
  content: "";
  position: absolute;
  inset: -30%;
  background-image: url('fundo.jpg');
  background-size: cover;
  background-position: center;
  opacity: 0.25;
  z-index: 0;
}

.chart-bg > * {
  position: relative;
  z-index: 1;
}

#customTooltip {
  position: absolute;
  background: #ffffff;
  border: 1px solid #bbb;
  padding: 10px 12px;
  font-size: 13px;
  line-height: 1.5;
  box-shadow: 0 2px 6px rgba(0,0,0,0.25);
  border-radius: 4px;
  display: none;
  pointer-events: none;
  z-index: 9999;
  white-space: nowrap;
}

.size-legend {
  margin-top: 6px;
  margin-left: 80px;
  font-size: 15px;
  color: #000;
}
</style>

<script>
google.charts.load('current', { packages: ['corechart'] });
google.charts.setOnLoadCallback(init);

const CSV_JUNIORS =
'https://docs.google.com/spreadsheets/d/e/2PACX-1vSHkysTN6roFag5cFJv97rmXIsO9vKLKaAXmJxbeAD0v4klws329T8nwBI1ftUFKvrukkvLYM9vPysK/pub?gid=1894723608&single=true&output=csv';

const CSV_MAJORS = 
'https://docs.google.com/spreadsheets/d/e/2PACX-1vSld_qDJOwo6IuHoTPH4P2jf28opor0WkbCue_em-EDMlGjV5ZbN0kNHZMGxcdUsKCgkzVVys9kfu7D/pub?gid=1389713239&single=true&output=csv';

function init() {
  showScatter();
}

function showScatter() {
  toggle('scatter');
  drawScatter();
}

function showBubble() {
  toggle('bubble');
  drawBubble();
}

function toggle(type) {
  scatterBox.classList.remove('active');
  bubbleBox.classList.remove('active');
  document.getElementById(type + 'Box').classList.add('active');

  btnScatter.classList.remove('active');
  btnBubble.classList.remove('active');
  document.getElementById('btn' + type.charAt(0).toUpperCase() + type.slice(1)).classList.add('active');
}

function redraw() {
  if (scatterBox.classList.contains('active')) drawScatter();
  else drawBubble();
}

async function loadCSV(url) {
  const csv = await (await fetch(url)).text();
  return csv.trim().split('\n').slice(1);
}

/* ================= SCATTER ================= */
async function drawScatter() {

  const showJ = chkJ.checked;
  const showM = chkM.checked;

  let rows = [];
  if (showJ) rows = rows.concat(await loadCSV(CSV_JUNIORS));
  if (showM) rows = rows.concat(await loadCSV(CSV_MAJORS));

  scatter.innerHTML = "";
  if (!rows.length) return;

  rows.sort((a,b)=>{
    const ca = a.split(',').map(x=>x.replace(/"/g,'').trim());
    const cb = b.split(',').map(x=>x.replace(/"/g,'').trim());
    return parseFloat(ca[1]) - parseFloat(cb[1]);
  });

  const data = new google.visualization.DataTable();
  data.addColumn('string','Name');
  data.addColumn('number','Measured + Indicated');
  data.addColumn('number','P+P / M+I');
  data.addColumn({ type:'string', role:'tooltip', p:{html:true} });

  const links = [];

  rows.forEach(r=>{
    const c = r.split(',').map(x=>x.replace(/"/g,'').trim());
    const mi = parseFloat(c[1]);
    const ratio = parseFloat(c[2]);
    if (isNaN(mi)||isNaN(ratio)) return;
    data.addRow([c[0], mi, ratio, '']);
    links.push(c[5]);
  });

  if (data.getNumberOfRows() === 0) return;

  const chart = new google.visualization.ScatterChart(scatter);
  google.visualization.events.removeAllListeners(chart);

  google.visualization.events.addListener(chart,'onmouseover', e=>{
    if(e.row==null) return;
    const cli = chart.getChartLayoutInterface();
    const x = cli.getXLocation(data.getValue(e.row,1));
    const y = cli.getYLocation(data.getValue(e.row,2));
    const c = rows[e.row].split(',').map(x=>x.replace(/"/g,'').trim());

    customTooltip.innerHTML = `
      <strong>${c[0]}</strong><br><br>
      <b>Measured + Indicated:</b> ${c[1]}<br>
      <b>P+P / M+I:</b> ${c[2]}<br>
      <b>Ore Type:</b> ${c[4]}<br>
      <b>Resources (Mt):</b> ${c[3]}<br>
      <span style="color:#0066cc">Click to open source</span>
    `;
    customTooltip.style.left = scatter.offsetLeft + x + 15 + 'px';
    customTooltip.style.top  = scatter.offsetTop + y - 10 + 'px';
    customTooltip.style.display='block';
  });

  google.visualization.events.addListener(chart,'onmouseout',()=>{
    customTooltip.style.display='none';
  });

  google.visualization.events.addListener(chart,'select',()=>{
    const s = chart.getSelection();
    if(s.length) window.open(links[s[0].row],'_blank');
  });

  chart.draw(data,{
    hAxis:{ title:'Measured + Indicated (%)' },
    vAxis:{ title:'P+P / M+I (%)' },
    tooltip:{ trigger:'none' },
    height:480,
    pointSize:8,
    backgroundColor:'transparent',
    chartArea:{ top:30, left:95, right:230, bottom:120 }
  });
}

/* ================= BUBBLE ================= */
async function drawBubble() {

  bubble.innerHTML = "";
  bubbleLegend.style.display = "none";

  const showJ = chkJ.checked;
  const showM = chkM.checked;

  let rows = [];
  if (showJ) rows = rows.concat(await loadCSV(CSV_JUNIORS));
  if (showM) rows = rows.concat(await loadCSV(CSV_MAJORS));

  if (!rows.length) return;

  rows.sort((a,b)=>{
    const ca = a.split(',').map(x=>x.replace(/"/g,'').trim());
    const cb = b.split(',').map(x=>x.replace(/"/g,'').trim());
    return parseFloat(ca[1]) - parseFloat(cb[1]);
  });

  const data = new google.visualization.DataTable();
  data.addColumn('string','ID');
  data.addColumn('number','Measured + Indicated');
  data.addColumn('number','P+P / M+I');
  data.addColumn('string','Ore Type');
  data.addColumn('number','Resources');
  data.addColumn('string','Company');
  data.addColumn('string','Link');

  rows.forEach(r=>{
    const c = r.split(',').map(x=>x.replace(/"/g,'').trim());
    const mi = parseFloat(c[1]);
    const ratio = parseFloat(c[2]);
    const res = parseFloat(c[3].replace(/\D/g,''));
    if (isNaN(mi)||isNaN(ratio)||isNaN(res)) return;
    data.addRow(['', mi, ratio, c[4], res, c[0], c[5]]);
  });

  if (data.getNumberOfRows() === 0) return;

  bubbleLegend.style.display = "block";

  const chart = new google.visualization.BubbleChart(bubble);
  google.visualization.events.removeAllListeners(chart);

  google.visualization.events.addListener(chart,'onmouseover', e=>{
    if(e.row==null) return;
    const cli = chart.getChartLayoutInterface();
    const x = cli.getXLocation(data.getValue(e.row,1));
    const y = cli.getYLocation(data.getValue(e.row,2));

    customTooltip.innerHTML = `
      <strong>${data.getValue(e.row,5)}</strong><br><br>
      <b>Measured + Indicated:</b> ${data.getValue(e.row,1)}<br>
      <b>P+P / M+I:</b> ${data.getValue(e.row,2)}<br>
      <b>Ore Type:</b> ${data.getValue(e.row,3)}<br>
      <b>Resources (Mt):</b> ${data.getValue(e.row,4)}<br>
      <span style="color:#0066cc">Click to open source</span>
    `;
    customTooltip.style.left = bubble.offsetLeft + x + 15 + 'px';
    customTooltip.style.top  = bubble.offsetTop + y - 10 + 'px';
    customTooltip.style.display='block';
  });

  google.visualization.events.addListener(chart,'onmouseout',()=>{
    customTooltip.style.display='none';
  });

  google.visualization.events.addListener(chart,'select',()=>{
    const s = chart.getSelection();
    if(s.length) window.open(data.getValue(s[0].row,6),'_blank');
  });

  chart.draw(data,{
    hAxis:{ title:'Measured + Indicated (%)', minValue:-0.1, maxValue:1.0, baselineColor:'transparent' },
    vAxis:{ title:'P+P / M+I (%)', minValue:-0.1, maxValue:1.0, baselineColor:'transparent' },
    bubble:{ textStyle:{ fontSize:0 } },
    legend:{ position:'right' },
    tooltip:{ trigger:'none' },
    height:420,
    backgroundColor:'transparent',
    chartArea:{ top:30, left:95, right:230, bottom:60 }
  });
}
</script>
</head>

<body>

<h1 class="page-title">Feasibility Study</h1>

<div class="chart-menu">
  <button id="btnScatter" onclick="showScatter()">Scatter Chart</button>
  <button id="btnBubble" onclick="showBubble()">Bubble Chart</button>
</div>

<div class="chart-menu">
  <label><input type="checkbox" id="chkJ" checked onchange="redraw()"> Juniors</label>
  <label style="margin-left:15px">
    <input type="checkbox" id="chkM" onchange="redraw()"> Majors
  </label>
</div>

<div id="scatterBox" class="chart-box chart-bg active">
  <div id="scatter"></div>
</div>

<div id="bubbleBox" class="chart-box chart-bg">
  <div id="bubble"></div>
  <div id="bubbleLegend" class="size-legend">
    Bubble size = Resources (Mt)
  </div>
</div>

<div id="customTooltip"></div>

</body>
</html>
